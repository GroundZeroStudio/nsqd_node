    

nsqd解析:nsqd 和 nsqlookupd 之间的通信
==============================

  nsqdlookupd 可以用来管理 nsqd 中的 topic 以及 channel 客户端可以通过 nsqlookupd 来获取指定 topic 的 nsqd,通过 TCP 连接接收 nsqd 中 topic 以及 channel 的改变,并通过 HTTP 来通知客户端 nsqd 信息.

[](about:blank#lookupLoop "lookupLoop")lookupLoop
=================================================

  说到 nsqdlookupd 还要提起 nsqd 初始化时 Main 中执行的 n.waitGroup.Wrap(n.lookupLoop) 这个函数是干什么的呢?

<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 由 nsqd 子协程运行的方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *NSQD)</span> <span class="title">lookupLoop</span><span class="params">()</span></span> {</span><br><span class="line">	<span class="keyword">var</span> lookupPeers []*lookupPeer</span><br><span class="line">	<span class="keyword">var</span> lookupAddrs []<span class="keyword">string</span></span><br><span class="line">	connect := <span class="literal">true</span></span><br><span class="line">	<span class="comment">// 服务器名字</span></span><br><span class="line">	hostname, err := os.Hostname()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		n.logf(LOG_FATAL, <span class="string">"failed to get hostname - %s"</span>, err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 15秒执行一次 Ping 指令</span></span><br><span class="line">	ticker := time.Tick(<span class="number">15</span> * time.Second)</span><br><span class="line">	<span class="keyword">for</span> {</span><br><span class="line">		<span class="keyword">if</span> connect {</span><br><span class="line">			<span class="comment">// 连接的所有 lookupd addr, NSQLookupdTCPAddresses 参数由 nsqd 开始执行时进行设置</span></span><br><span class="line">			<span class="keyword">for</span> _, host := <span class="keyword">range</span> n.getOpts().NSQLookupdTCPAddresses {</span><br><span class="line">				<span class="keyword">if</span> in(host, lookupAddrs) {</span><br><span class="line">					<span class="comment">// 这个 lookupd 已经连接完毕了</span></span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				}</span><br><span class="line">				<span class="comment">// 新的 lookupd,建立连接</span></span><br><span class="line">				n.logf(LOG_INFO, <span class="string">"LOOKUP(%s): adding peer"</span>, host)</span><br><span class="line">				<span class="comment">// 新建一个 lookupPeer 用来管理和 lookupd 的连接</span></span><br><span class="line">				lookupPeer := newLookupPeer(host, n.getOpts().MaxBodySize, n.logf,</span><br><span class="line">					connectCallback(n, hostname))</span><br><span class="line">				<span class="comment">// 开始这个连接</span></span><br><span class="line">				lookupPeer.Command(<span class="literal">nil</span>)</span><br><span class="line">				<span class="comment">// 连接成功后进行记录即可</span></span><br><span class="line">				lookupPeers = <span class="built_in">append</span>(lookupPeers, lookupPeer)</span><br><span class="line">				lookupAddrs = <span class="built_in">append</span>(lookupAddrs, host)</span><br><span class="line">			}</span><br><span class="line">			<span class="comment">// 记录到 nsqd.lookupPeers 中</span></span><br><span class="line">			n.lookupPeers.Store(lookupPeers)</span><br><span class="line">			connect = <span class="literal">false</span></span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// 所有和 lookupd 连接完毕，运行监听 nsqd 即可</span></span><br><span class="line">		<span class="keyword">select</span> {</span><br><span class="line">		<span class="keyword">case</span> &lt;-ticker:</span><br><span class="line">			<span class="comment">// 发送心跳，听取 lookupd 进程的响应</span></span><br><span class="line">			<span class="keyword">for</span> _, lookupPeer := <span class="keyword">range</span> lookupPeers {</span><br><span class="line">				n.logf(LOG_DEBUG, <span class="string">"LOOKUPD(%s): sending heartbeat"</span>, lookupPeer)</span><br><span class="line">				<span class="comment">// Ping 指令</span></span><br><span class="line">				cmd := nsq.Ping()</span><br><span class="line">				<span class="comment">// 执行 Ping 指令</span></span><br><span class="line">				_, err := lookupPeer.Command(cmd)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">					n.logf(LOG_ERROR, <span class="string">"LOOKUPD(%s): %s - %s"</span>, lookupPeer, cmd, err)</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		<span class="keyword">case</span> val := &lt;-n.notifyChan:</span><br><span class="line">			<span class="comment">// 这个 nsqd 的 topic 或 channel 发生了改变,通知 lookupd 新的 topic 或者 channel</span></span><br><span class="line">			<span class="keyword">var</span> cmd *nsq.Command</span><br><span class="line">			<span class="keyword">var</span> branch <span class="keyword">string</span></span><br><span class="line">			<span class="comment">// 判断是 topic 还是 channel 发生了改变</span></span><br><span class="line">			<span class="keyword">switch</span> val.(<span class="keyword">type</span>) {</span><br><span class="line">			<span class="keyword">case</span> *Channel:</span><br><span class="line">				<span class="comment">// 通知所有 nsqlookupds 创建或者移除一个 channel</span></span><br><span class="line">				branch = <span class="string">"channel"</span></span><br><span class="line">				channel := val.(*Channel)</span><br><span class="line">				<span class="comment">// 封装对应的指令</span></span><br><span class="line">				<span class="keyword">if</span> channel.Exiting() == <span class="literal">true</span> {</span><br><span class="line">					<span class="comment">// channel 不用了，就移除掉</span></span><br><span class="line">					cmd = nsq.UnRegister(channel.topicName, channel.name)</span><br><span class="line">				} <span class="keyword">else</span> {</span><br><span class="line">					<span class="comment">// 添加新的 channel</span></span><br><span class="line">					cmd = nsq.Register(channel.topicName, channel.name)</span><br><span class="line">				}</span><br><span class="line">			<span class="keyword">case</span> *Topic:</span><br><span class="line">				<span class="comment">// 通知所有 nsqlookupds 创建或者移除一个 topic</span></span><br><span class="line">				branch = <span class="string">"topic"</span></span><br><span class="line">				topic := val.(*Topic)</span><br><span class="line">				<span class="comment">// 封装对应的指令</span></span><br><span class="line">				<span class="keyword">if</span> topic.Exiting() == <span class="literal">true</span> {</span><br><span class="line">					<span class="comment">// topic 不用就注销掉</span></span><br><span class="line">					cmd = nsq.UnRegister(topic.name, <span class="string">""</span>)</span><br><span class="line">				} <span class="keyword">else</span> {</span><br><span class="line">					<span class="comment">// 创建新的 topic</span></span><br><span class="line">					cmd = nsq.Register(topic.name, <span class="string">""</span>)</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			<span class="comment">// 通知所有 nsqlookupd</span></span><br><span class="line">			<span class="keyword">for</span> _, lookupPeer := <span class="keyword">range</span> lookupPeers {</span><br><span class="line">				n.logf(LOG_INFO, <span class="string">"LOOKUPD(%s): %s %s"</span>, lookupPeer, branch, cmd)</span><br><span class="line">				<span class="comment">// 对所有 lookupd 均发送指令</span></span><br><span class="line">				_, err := lookupPeer.Command(cmd)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">					n.logf(LOG_ERROR, <span class="string">"LOOKUPD(%s): %s - %s"</span>, lookupPeer, cmd, err)</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		<span class="keyword">case</span> &lt;-n.optsNotificationChan:</span><br><span class="line">			<span class="comment">// lookupd 配置地址更新了,重新建立连接</span></span><br><span class="line">			<span class="keyword">var</span> tmpPeers []*lookupPeer</span><br><span class="line">			<span class="keyword">var</span> tmpAddrs []<span class="keyword">string</span></span><br><span class="line">			<span class="keyword">for</span> _, lp := <span class="keyword">range</span> lookupPeers {</span><br><span class="line">				<span class="keyword">if</span> in(lp.addr, n.getOpts().NSQLookupdTCPAddresses) {</span><br><span class="line">					<span class="comment">// 该连接没有变动</span></span><br><span class="line">					tmpPeers = <span class="built_in">append</span>(tmpPeers, lp)</span><br><span class="line">					tmpAddrs = <span class="built_in">append</span>(tmpAddrs, lp.addr)</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				}</span><br><span class="line">				<span class="comment">// 该链接变动了,就关闭掉</span></span><br><span class="line">				n.logf(LOG_INFO, <span class="string">"LOOKUP(%s): removing peer"</span>, lp)</span><br><span class="line">				lp.Close()</span><br><span class="line">			}</span><br><span class="line">			<span class="comment">// 新的 lookupPeers</span></span><br><span class="line">			lookupPeers = tmpPeers</span><br><span class="line">			lookupAddrs = tmpAddrs</span><br><span class="line">			<span class="comment">// 将 connect 设置为 true，就会在 for 循环开始重新连接新的 lookupd，并更新 nsqd 中的 lookupPeer</span></span><br><span class="line">			connect = <span class="literal">true</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-n.exitChan:</span><br><span class="line">			<span class="comment">// 退出 lokupLoop</span></span><br><span class="line">			<span class="keyword">goto</span> exit</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">exit:</span><br><span class="line">	n.logf(LOG_INFO, <span class="string">"LOOKUP: closing"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

  创建 lookuppeer 时传入了一个连接回调函数,下面就是这个函数,后面会看看怎么使用的

<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">connectCallback</span><span class="params">(n *NSQD, hostname <span class="keyword">string</span>)</span> <span class="title">func</span><span class="params">(*lookupPeer)</span></span> {</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(lp *lookupPeer)</span></span> {</span><br><span class="line">		ci := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>{})</span><br><span class="line">		<span class="comment">// 版本号</span></span><br><span class="line">		ci[<span class="string">"version"</span>] = version.Binary</span><br><span class="line">		<span class="comment">// TCP port</span></span><br><span class="line">		ci[<span class="string">"tcp_port"</span>] = n.RealTCPAddr().Port</span><br><span class="line">		<span class="comment">// HTTP port</span></span><br><span class="line">		ci[<span class="string">"http_port"</span>] = n.RealHTTPAddr().Port</span><br><span class="line">		ci[<span class="string">"hostname"</span>] = hostname</span><br><span class="line">		ci[<span class="string">"broadcast_address"</span>] = n.getOpts().BroadcastAddress</span><br><span class="line">		<span class="comment">// 生成 IDENTIFY 指令</span></span><br><span class="line">		cmd, err := nsq.Identify(ci)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			lp.Close()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// lookuppeer 执行 Identify 指令</span></span><br><span class="line">		resp, err := lp.Command(cmd)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			n.logf(LOG_ERROR, <span class="string">"LOOKUPD(%s): %s - %s"</span>, lp, cmd, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		} <span class="keyword">else</span> <span class="keyword">if</span> bytes.Equal(resp, []<span class="keyword">byte</span>(<span class="string">"E_INVALID"</span>)) {</span><br><span class="line">			<span class="comment">// 识别失败,关闭连接</span></span><br><span class="line">			n.logf(LOG_INFO, <span class="string">"LOOKUPD(%s): lookupd returned %s"</span>, lp, resp)</span><br><span class="line">			lp.Close()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		} <span class="keyword">else</span> {</span><br><span class="line">			<span class="comment">// 打印一下瞅瞅</span></span><br><span class="line">			err = json.Unmarshal(resp, &amp;lp.Info)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">				n.logf(LOG_ERROR, <span class="string">"LOOKUPD(%s): parsing response - %s"</span>, lp, resp)</span><br><span class="line">				lp.Close()</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			} <span class="keyword">else</span> {</span><br><span class="line">				n.logf(LOG_INFO, <span class="string">"LOOKUPD(%s): peer info %+v"</span>, lp, lp.Info)</span><br><span class="line">				<span class="keyword">if</span> lp.Info.BroadcastAddress == <span class="string">""</span> {</span><br><span class="line">					n.logf(LOG_ERROR, <span class="string">"LOOKUPD(%s): no broadcast address"</span>, lp)</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 一次性把所有 topic 和 channel 注册进 lookupd 要执行的指令，低频操作，挺费的</span></span><br><span class="line">		<span class="keyword">var</span> commands []*nsq.Command</span><br><span class="line">		n.RLock()</span><br><span class="line">		<span class="keyword">for</span> _, topic := <span class="keyword">range</span> n.topicMap {</span><br><span class="line">			topic.RLock()</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(topic.channelMap) == <span class="number">0</span> {</span><br><span class="line">				commands = <span class="built_in">append</span>(commands, nsq.Register(topic.name, <span class="string">""</span>))</span><br><span class="line">			} <span class="keyword">else</span> {</span><br><span class="line">				<span class="keyword">for</span> _, channel := <span class="keyword">range</span> topic.channelMap {</span><br><span class="line">					commands = <span class="built_in">append</span>(commands, nsq.Register(channel.topicName, channel.name))</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			topic.RUnlock()</span><br><span class="line">		}</span><br><span class="line">		n.RUnlock()</span><br><span class="line">		<span class="comment">// 依次注册到 lookupd 中即可</span></span><br><span class="line">		<span class="keyword">for</span> _, cmd := <span class="keyword">range</span> commands {</span><br><span class="line">			n.logf(LOG_INFO, <span class="string">"LOOKUPD(%s): %s"</span>, lp, cmd)</span><br><span class="line">			_, err := lp.Command(cmd)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">				n.logf(LOG_ERROR, <span class="string">"LOOKUPD(%s): %s - %s"</span>, lp, cmd, err)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

[](about:blank#lookupPeer "lookupPeer")lookupPeer
=================================================

创建 lookuppeer

<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用来管理和 lookupd 之间的连接</span></span><br><span class="line"><span class="keyword">type</span> lookupPeer <span class="keyword">struct</span> {</span><br><span class="line">	logf            lg.AppLogFunc     <span class="comment">// 日志等级信息</span></span><br><span class="line">	addr            <span class="keyword">string</span>            <span class="comment">// lookupd 的地址</span></span><br><span class="line">	conn            net.Conn          <span class="comment">// 对应的连接 TCP 的</span></span><br><span class="line">	state           <span class="keyword">int32</span>             <span class="comment">// 连接状态</span></span><br><span class="line">	connectCallback <span class="function"><span class="keyword">func</span><span class="params">(*lookupPeer)</span> // 连接成功的 <span class="title">callback</span></span></span><br><span class="line"><span class="function">	<span class="title">maxBodySize</span>     <span class="title">int64</span>             // 最大存储大小</span></span><br><span class="line"><span class="function">	<span class="title">Info</span>            <span class="title">peerInfo</span>          // <span class="title">peerInfo</span> 初始化完成后由 <span class="title">lookupd</span> 返回的数据进行填写</span></span><br><span class="line"><span class="function">}</span></span><br><span class="line"><span class="function">// 创建一个 <span class="title">lookupdPeer</span> 并连接到对应地址，连接成功会调用 <span class="title">connectCallback</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">newLookupPeer</span><span class="params">(addr <span class="keyword">string</span>, maxBodySize <span class="keyword">int64</span>, l lg.AppLogFunc, connectCallback <span class="keyword">func</span>(*lookupPeer)</span>) *<span class="title">lookupPeer</span></span> {</span><br><span class="line">	<span class="keyword">return</span> &amp;lookupPeer{</span><br><span class="line">		logf:            l,                 <span class="comment">// 日志信息</span></span><br><span class="line">		addr:            addr,              <span class="comment">// lookupd 的地址</span></span><br><span class="line">		state:           stateDisconnected, <span class="comment">// 初始状态为断开连接</span></span><br><span class="line">		maxBodySize:     maxBodySize,       <span class="comment">// 默认 5MB</span></span><br><span class="line">		connectCallback: connectCallback,   <span class="comment">// 连接回调函数</span></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

上面知道了,创建 lookuppeer 之后立即执行 lookuppeer.Command(nil)

<table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行传给 lookupd 的指令</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lp *lookupPeer)</span> <span class="title">Command</span><span class="params">(cmd *nsq.Command)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> {</span><br><span class="line">	<span class="comment">// 初始状态</span></span><br><span class="line">	initialState := lp.state</span><br><span class="line">	<span class="keyword">if</span> lp.state != stateConnected {</span><br><span class="line">		<span class="comment">// 初始化完还处于未连接状态</span></span><br><span class="line">		err := lp.Connect()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		}</span><br><span class="line">		lp.state = stateConnected</span><br><span class="line">		<span class="comment">// 尝试写入数据</span></span><br><span class="line">		_, err = lp.Write(nsq.MagicV1)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">			lp.Close()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> initialState == stateDisconnected {</span><br><span class="line">			<span class="comment">// 初始连接需要调用 connectCallback</span></span><br><span class="line">			lp.connectCallback(lp)</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> lp.state != stateConnected {</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"lookupPeer connectCallback() failed"</span>)</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span> cmd == <span class="literal">nil</span> {</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// 将消息写入连接</span></span><br><span class="line">	_, err := cmd.WriteTo(lp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		lp.Close()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// 读取回复并返回</span></span><br><span class="line">	resp, err := readResponseBounded(lp, lp.maxBodySize)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		lp.Close()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> resp, <span class="literal">nil</span></span><br><span class="line">}</span><br><span class="line"><span class="comment">// nsqd 和 lookupd 进行连接,实现了 connect 接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lp *lookupPeer)</span> <span class="title">Connect</span><span class="params">()</span> <span class="title">error</span></span> {</span><br><span class="line">	lp.logf(lg.INFO, <span class="string">"LOOKUP connecting to %s"</span>, lp.addr)</span><br><span class="line">	<span class="comment">// 进行 TCP 连接,一秒超时</span></span><br><span class="line">	conn, err := net.DialTimeout(<span class="string">"tcp"</span>, lp.addr, time.Second)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> {</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// 保存 tcp 连接</span></span><br><span class="line">	lp.conn = conn</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table>

  整个连接就是通过 lookupPeer 来管理一个对端 lookupd 进程,然后 LookupdLoop 中对所有 lookupd 建立连接并创建 lookupdPeer,后面更新配置也会更新 lookupPeers.然后在 lookupPeer 创建后立刻执行 Command 来进行初始化:调用 connectCallback,它的作用是验证这个 nsqd 以及将该 nsqd 上的所有 topic 和 channel 注册到 lookupd 中.

[](about:blank#%E5%B0%8F%E7%BB%93 "小结")小结
=========================================

  和 lookupd 的交互比较简单,建立连接后,如果修改了配置就在 lookupdLoop 中重新和所有 lookupd 建立连接,或者在 topic 或 channel 发生改变时通知 lookupd 即可
